<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Presentation</title>
    <link rel="stylesheet" href="style.css">
    <style>
      /* Minimal layout adjustments for the exported player */
      body,html{height:100%;margin:0}
      #slide-container{width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;background:#222;color:#fff;padding:2rem;box-sizing:border-box}
      #slide-container img{max-width:80%;max-height:40vh;border-radius:8px;margin-top:1rem}
      #start-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px}
      #start-button{font-size:1.25rem;padding:.8rem 1.4rem;border-radius:8px}
      #controls{display:flex;gap:8px;align-items:center}
      #voice-select{min-width:220px}
    </style>
  </head>
  <body>
    <main id="slide-container">
      <div id="start-overlay">
        <div id="controls">
          <select id="voice-select"><option>Loading voices…</option></select>
          <label>Rate <input id="rate" type="range" min="0.6" max="1.3" step="0.05" value="0.95"></label>
          <label>Pitch <input id="pitch" type="range" min="0.6" max="1.5" step="0.05" value="1.0"></label>
        </div>
        <button id="start-button">Click to Start Presentation</button>
      </div>
    </main>

    <script>
    // Exported player script — robust, avoids regex literals to prevent 'Invalid regular expression' errors
    (function(){
      const container = document.getElementById('slide-container');
      const startOverlay = document.getElementById('start-overlay');
      const startButton = document.getElementById('start-button');
      const voiceSelect = document.getElementById('voice-select');
      const rateInput = document.getElementById('rate');
      const pitchInput = document.getElementById('pitch');
      let slides = [];
      let current = 0;

      function splitIntoSentences(text){
        // Simple character-based sentence splitter (no regex)
        const out = [];
        let buf = '';
        for(let i=0;i<text.length;i++){
          const ch = text[i];
          buf += ch;
          if(ch === '.' || ch === '!' || ch === '?' || ch === '\n'){
            const s = buf.trim();
            if(s) out.push(s);
            buf = '';
          }
        }
        const rem = buf.trim();
        if(rem) out.push(rem);
        return out.length?out:[text];
      }

      function populateVoices(){
        const voices = (speechSynthesis.getVoices()||[]);
        voiceSelect.innerHTML = '';
        if(!voices.length){
          const o = document.createElement('option'); o.textContent='No voices available'; voiceSelect.appendChild(o); return;
        }
        // Prefer en-US when possible
        const us = voices.filter(v=>/en(-|_)?us/i.test(v.lang) || /american/i.test(v.name));
        const list = us.length?us:voices;
        list.forEach((v,i)=>{
          const opt = document.createElement('option'); opt.value = i; opt.textContent = v.name + ' - ' + v.lang; voiceSelect.appendChild(opt);
        });
      }

      function speakText(text, done){
        if(!text || !text.trim()){ setTimeout(done,1000); return; }
        const sentences = splitIntoSentences(text);
        let i = 0;
        function next(){
          if(i>=sentences.length){ done(); return; }
          const chunk = sentences[i++];
          const u = new SpeechSynthesisUtterance(chunk);
          const voices = (speechSynthesis.getVoices()||[]);
          const us = voices.filter(v=>/en(-|_)?us/i.test(v.lang) || /american/i.test(v.name));
          const list = us.length?us:voices;
          const sel = parseInt(voiceSelect.value,10);
          if(!isNaN(sel) && list[sel]) u.voice = list[sel];
          u.rate = parseFloat(rateInput.value)||0.95;
          u.pitch = parseFloat(pitchInput.value)||1.0;
          u.onend = ()=>setTimeout(next,220);
          u.onerror = ()=>setTimeout(next,250);
          speechSynthesis.speak(u);
        }
        next();
      }

      async function loadSlides(){
        try{
          const r = await fetch('slides.json');
          slides = await r.json();
          startButton.disabled = false;
        }catch(e){
          console.error('Failed loading slides.json', e); container.innerHTML = '<h1 style="color:#fff">Failed to load slides.json</h1>';
        }
      }

      function play(index){
        if(index>=slides.length){ container.innerHTML = '<h1>End of Presentation</h1>'; return; }
        const slide = slides[index];
        container.innerHTML = slide.html;
        // Extract plain text
        const tmp = document.createElement('div'); tmp.innerHTML = slide.html;
        const text = tmp.textContent || tmp.innerText || '';
        speakText(text, ()=> play(index+1));
      }

      startButton.addEventListener('click', ()=>{
        startOverlay.style.display = 'none';
        play(0);
      });

      populateVoices();
      if(typeof speechSynthesis!=='undefined') speechSynthesis.onvoiceschanged = populateVoices;
      loadSlides();
    })();
    </script>
  </body>
</html>