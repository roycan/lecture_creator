<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Health Check Monitoring Dashboard</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .status-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border-left: 5px solid #3273dc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status-card.healthy {
      border-left-color: #28a745;
    }
    .status-card.warning {
      border-left-color: #ffc107;
    }
    .status-card.error {
      border-left-color: #dc3545;
    }
    .status-icon {
      font-size: 48px;
      text-align: center;
      margin: 10px 0;
    }
    .status-label {
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      margin: 10px 0;
    }
    .status-value {
      text-align: center;
      font-size: 24px;
      color: #666;
    }
    .code-block {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      margin: 10px 0;
    }
    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
    }
    .log-entry {
      padding: 5px;
      border-bottom: 1px solid #333;
    }
    .log-success { color: #4ec9b0; }
    .log-warning { color: #ce9178; }
    .log-error { color: #f48771; }
    .refresh-button {
      background: #3273dc;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
    }
    .refresh-button:hover {
      background: #2366d1;
    }
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-button {
      padding: 10px 20px;
      border: none;
      background: #e0e0e0;
      cursor: pointer;
      border-radius: 5px;
    }
    .tab-button.active {
      background: #3273dc;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üè• Health Check Monitoring Dashboard</h1>
      <p><strong>For:</strong> Real-time system status monitoring</p>
      <p><strong>Goal:</strong> Know immediately when something is wrong</p>

      <!-- Tab Navigation -->
      <div class="tab-buttons">
        <button class="tab-button active" onclick="showTab('demo')">Live Demo</button>
        <button class="tab-button" onclick="showTab('setup')">Setup Code</button>
        <button class="tab-button" onclick="showTab('external')">External Monitoring</button>
      </div>

      <!-- Demo Tab -->
      <div id="tab-demo" class="tab-content active">
        <h2>System Status</h2>
        <p><small>Last updated: <span id="last-update">Never</span></small></p>
        <button class="refresh-button" onclick="checkHealth()">üîÑ Refresh Status</button>

        <div class="dashboard-grid">
          <div id="server-status" class="status-card">
            <div class="status-icon">‚è≥</div>
            <div class="status-label">Server Status</div>
            <div class="status-value">Checking...</div>
          </div>

          <div id="database-status" class="status-card">
            <div class="status-icon">‚è≥</div>
            <div class="status-label">Database</div>
            <div class="status-value">Checking...</div>
          </div>

          <div id="memory-status" class="status-card">
            <div class="status-icon">‚è≥</div>
            <div class="status-label">Memory Usage</div>
            <div class="status-value">Checking...</div>
          </div>

          <div id="uptime-status" class="status-card">
            <div class="status-icon">‚è≥</div>
            <div class="status-label">Uptime</div>
            <div class="status-value">Checking...</div>
          </div>
        </div>

        <h3>Recent Health Check Logs</h3>
        <div id="health-logs" class="log-container">
          <div class="log-entry">Waiting for health check...</div>
        </div>
      </div>

      <!-- Setup Tab -->
      <div id="tab-setup" class="tab-content">
        <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px;">
          <h2>1. Basic Health Check Endpoint</h2>
          <div class="code-block">// app.js
app.get('/health', (req, res) => {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    environment: process.env.NODE_ENV
  });
});</div>

          <h2>2. Advanced Health Check with Database</h2>
          <div class="code-block">// app.js
app.get('/health', (req, res) => {
  const health = {
    status: 'healthy',
    timestamp: new Date().toISOString(),
    checks: {}
  };
  
  // Check server
  health.checks.server = {
    status: 'healthy',
    uptime: Math.floor(process.uptime()) + ' seconds',
    memory: {
      used: Math.round(process.memoryUsage().heapUsed / 1024 / 1024) + ' MB',
      total: Math.round(process.memoryUsage().heapTotal / 1024 / 1024) + ' MB'
    }
  };
  
  // Check database
  try {
    const result = db.prepare('SELECT 1 as test').get();
    health.checks.database = {
      status: 'healthy',
      connection: 'active',
      test: result.test === 1 ? 'passed' : 'failed'
    };
  } catch (error) {
    health.status = 'unhealthy';
    health.checks.database = {
      status: 'unhealthy',
      error: error.message
    };
  }
  
  // Check disk space (if needed)
  try {
    const stats = fs.statSync('database.db');
    health.checks.storage = {
      status: 'healthy',
      database_size: Math.round(stats.size / 1024) + ' KB'
    };
  } catch (error) {
    health.checks.storage = {
      status: 'warning',
      error: error.message
    };
  }
  
  // Return appropriate status code
  const statusCode = health.status === 'healthy' ? 200 : 503;
  res.status(statusCode).json(health);
});</div>

          <h2>3. Admin Dashboard HTML</h2>
          <div class="code-block">&lt;!-- views/admin-health.ejs --&gt;
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Health Dashboard&lt;/title&gt;
  &lt;style&gt;
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    .status-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border-left: 5px solid #28a745;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status-card.unhealthy {
      border-left-color: #dc3545;
    }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;üè• System Health Dashboard&lt;/h1&gt;
  
  &lt;button onclick="checkHealth()"&gt;üîÑ Refresh&lt;/button&gt;
  
  &lt;div class="dashboard-grid" id="dashboard"&gt;
    &lt;div class="status-card"&gt;
      &lt;h3&gt;Loading...&lt;/h3&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  
  &lt;script&gt;
    async function checkHealth() {
      try {
        const response = await fetch('/health');
        const data = await response.json();
        
        const dashboard = document.getElementById('dashboard');
        dashboard.innerHTML = '';
        
        // Server card
        const serverCard = document.createElement('div');
        serverCard.className = 'status-card';
        serverCard.innerHTML = `
          &lt;h3&gt;üñ•Ô∏è Server&lt;/h3&gt;
          &lt;p&gt;Status: ${data.checks.server.status}&lt;/p&gt;
          &lt;p&gt;Uptime: ${data.checks.server.uptime}&lt;/p&gt;
          &lt;p&gt;Memory: ${data.checks.server.memory.used}&lt;/p&gt;
        `;
        dashboard.appendChild(serverCard);
        
        // Database card
        const dbCard = document.createElement('div');
        dbCard.className = 'status-card';
        if (data.checks.database.status === 'unhealthy') {
          dbCard.className += ' unhealthy';
        }
        dbCard.innerHTML = `
          &lt;h3&gt;üíæ Database&lt;/h3&gt;
          &lt;p&gt;Status: ${data.checks.database.status}&lt;/p&gt;
          &lt;p&gt;Connection: ${data.checks.database.connection || 'N/A'}&lt;/p&gt;
        `;
        dashboard.appendChild(dbCard);
        
        // Storage card
        if (data.checks.storage) {
          const storageCard = document.createElement('div');
          storageCard.className = 'status-card';
          storageCard.innerHTML = `
            &lt;h3&gt;üìÅ Storage&lt;/h3&gt;
            &lt;p&gt;Status: ${data.checks.storage.status}&lt;/p&gt;
            &lt;p&gt;DB Size: ${data.checks.storage.database_size || 'N/A'}&lt;/p&gt;
          `;
          dashboard.appendChild(storageCard);
        }
        
      } catch (error) {
        alert('Failed to check health: ' + error.message);
      }
    }
    
    // Auto-refresh every 30 seconds
    setInterval(checkHealth, 30000);
    
    // Initial check
    checkHealth();
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</div>

          <h2>4. Health Check with Logging</h2>
          <div class="code-block">// app.js
const logger = require('./config/logger');

app.get('/health', (req, res) => {
  const startTime = Date.now();
  
  const health = {
    status: 'healthy',
    timestamp: new Date().toISOString(),
    checks: {}
  };
  
  // Server check
  const memoryUsed = process.memoryUsage().heapUsed / 1024 / 1024;
  const memoryTotal = process.memoryUsage().heapTotal / 1024 / 1024;
  const memoryPercent = (memoryUsed / memoryTotal) * 100;
  
  health.checks.server = {
    status: 'healthy',
    uptime: Math.floor(process.uptime()),
    memory: {
      used: Math.round(memoryUsed) + ' MB',
      total: Math.round(memoryTotal) + ' MB',
      percent: Math.round(memoryPercent) + '%'
    }
  };
  
  // Warn if memory > 80%
  if (memoryPercent > 80) {
    logger.WARN('High memory usage detected', {
      percent: memoryPercent,
      used: memoryUsed,
      total: memoryTotal
    });
  }
  
  // Database check
  try {
    const result = db.prepare('SELECT COUNT(*) as count FROM residents').get();
    health.checks.database = {
      status: 'healthy',
      connection: 'active',
      residents_count: result.count
    };
  } catch (error) {
    health.status = 'unhealthy';
    health.checks.database = {
      status: 'unhealthy',
      error: error.message
    };
    
    logger.ERROR('Database health check failed', {
      error: error.message
    });
  }
  
  const duration = Date.now() - startTime;
  
  // Log slow health checks
  if (duration > 1000) {
    logger.WARN('Slow health check', {
      duration: duration + 'ms'
    });
  }
  
  const statusCode = health.status === 'healthy' ? 200 : 503;
  res.status(statusCode).json(health);
});</div>
        </div>
      </div>

      <!-- External Monitoring Tab -->
      <div id="tab-external" class="tab-content">
        <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px;">
          <h2>External Monitoring Services</h2>
          <p>Setup external services to monitor your app 24/7 and alert you when it's down.</p>

          <h3>1. UptimeRobot (Recommended - Free Tier)</h3>
          <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0;">
            <p><strong>Features (Free):</strong></p>
            <ul>
              <li>50 monitors</li>
              <li>5-minute checks</li>
              <li>Email/SMS alerts</li>
              <li>Public status pages</li>
            </ul>
          </div>

          <h4>Setup Steps:</h4>
          <ol>
            <li>Go to <a href="https://uptimerobot.com" target="_blank">uptimerobot.com</a></li>
            <li>Create free account</li>
            <li>Click "+ Add New Monitor"</li>
            <li>Select "HTTP(s)" monitor type</li>
            <li>Enter your app URL: <code>https://your-app.up.railway.app/health</code></li>
            <li>Set interval: 5 minutes</li>
            <li>Add alert contacts (email, SMS)</li>
            <li>Click "Create Monitor"</li>
          </ol>

          <h4>Alert Example:</h4>
          <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin: 15px 0;">
            <p><strong>üö® UptimeRobot Alert</strong></p>
            <p>Your monitor "Barangay App" is DOWN!</p>
            <p><strong>URL:</strong> https://barangay-app.up.railway.app/health</p>
            <p><strong>Reason:</strong> Connection timeout (30s)</p>
            <p><strong>Time:</strong> Jan 15, 2024 - 2:30 AM</p>
          </div>

          <h3>2. Better Uptime (Alternative)</h3>
          <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0;">
            <p><strong>Features (Free):</strong></p>
            <ul>
              <li>10 monitors</li>
              <li>3-minute checks</li>
              <li>Email/SMS/Slack alerts</li>
              <li>Incident management</li>
            </ul>
          </div>

          <h4>Setup:</h4>
          <ol>
            <li>Go to <a href="https://betteruptime.com" target="_blank">betteruptime.com</a></li>
            <li>Create free account</li>
            <li>Click "Add Monitor"</li>
            <li>Enter URL: <code>https://your-app.up.railway.app/health</code></li>
            <li>Set check frequency: 3 minutes</li>
            <li>Configure alerting (email, Slack, etc.)</li>
          </ol>

          <h3>3. Railway Built-in Monitoring</h3>
          <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0;">
            <p><strong>Railway Dashboard provides:</strong></p>
            <ul>
              <li>CPU usage graphs</li>
              <li>Memory usage graphs</li>
              <li>Network traffic</li>
              <li>Deployment logs</li>
              <li>Crash alerts</li>
            </ul>
          </div>

          <h4>Access Railway Metrics:</h4>
          <ol>
            <li>Go to railway.app</li>
            <li>Select your project</li>
            <li>Click on your service</li>
            <li>Click "Metrics" tab</li>
            <li>View CPU, Memory, Network graphs</li>
          </ol>

          <h3>4. Custom Monitoring Script (Advanced)</h3>
          <div class="code-block">// monitor.js - Run on separate server or your computer
const fetch = require('node-fetch');
const nodemailer = require('nodemailer');

const APP_URL = 'https://your-app.up.railway.app/health';
const CHECK_INTERVAL = 5 * 60 * 1000; // 5 minutes

let consecutiveFailures = 0;

async function checkHealth() {
  try {
    const response = await fetch(APP_URL, {
      timeout: 10000 // 10 second timeout
    });
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.status === 'healthy') {
        console.log('‚úÖ App is healthy');
        consecutiveFailures = 0;
      } else {
        console.log('‚ö†Ô∏è App is unhealthy:', data);
        handleFailure('App returned unhealthy status');
      }
    } else {
      console.log('‚ùå HTTP error:', response.status);
      handleFailure(`HTTP ${response.status}`);
    }
    
  } catch (error) {
    console.error('‚ùå Check failed:', error.message);
    handleFailure(error.message);
  }
}

function handleFailure(reason) {
  consecutiveFailures++;
  
  // Send alert after 3 consecutive failures
  if (consecutiveFailures >= 3) {
    sendAlert(reason);
  }
}

async function sendAlert(reason) {
  const transporter = nodemailer.createTransporter({
    service: 'gmail',
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASSWORD
    }
  });
  
  await transporter.sendMail({
    from: process.env.EMAIL_USER,
    to: process.env.ADMIN_EMAIL,
    subject: 'üö® APP DOWN - Barangay System',
    text: `
      Your app is DOWN!
      
      URL: ${APP_URL}
      Reason: ${reason}
      Consecutive Failures: ${consecutiveFailures}
      Time: ${new Date().toISOString()}
      
      Please check immediately!
    `
  });
  
  console.log('üìß Alert email sent');
}

// Run check every 5 minutes
setInterval(checkHealth, CHECK_INTERVAL);

// Initial check
checkHealth();

console.log('üè• Monitoring started for:', APP_URL);</div>

          <h3>Monitoring Checklist</h3>
          <div style="background: #d4edda; padding: 20px; border-radius: 8px;">
            <ul style="text-align: left;">
              <li>‚úÖ Create /health endpoint in your app</li>
              <li>‚úÖ Test health endpoint locally</li>
              <li>‚úÖ Deploy to Railway</li>
              <li>‚úÖ Setup UptimeRobot monitoring</li>
              <li>‚úÖ Add email alert contact</li>
              <li>‚úÖ Test alerts by intentionally breaking app</li>
              <li>‚úÖ Check Railway dashboard metrics</li>
              <li>‚úÖ Document response procedures</li>
              <li>‚úÖ Test monthly to ensure alerts work</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById('tab-' + tabName).classList.add('active');
      event.target.classList.add('active');
    }

    // Simulated health check for demo
    async function checkHealth() {
      const logs = document.getElementById('health-logs');
      const timestamp = new Date().toLocaleTimeString();
      
      // Simulate checking
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Update cards
      updateCard('server-status', {
        icon: '‚úÖ',
        status: 'Healthy',
        class: 'healthy'
      });
      
      updateCard('database-status', {
        icon: '‚úÖ',
        status: 'Connected',
        class: 'healthy'
      });
      
      updateCard('memory-status', {
        icon: '‚ö†Ô∏è',
        status: '76%',
        class: 'warning'
      });
      
      updateCard('uptime-status', {
        icon: '‚úÖ',
        status: '12 days',
        class: 'healthy'
      });
      
      // Add log entry
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry log-success';
      logEntry.textContent = `[${timestamp}] ‚úÖ Health check passed - All systems operational`;
      logs.insertBefore(logEntry, logs.firstChild);
      
      // Keep only last 10 logs
      while (logs.children.length > 10) {
        logs.removeChild(logs.lastChild);
      }
      
      // Update timestamp
      document.getElementById('last-update').textContent = timestamp;
    }
    
    function updateCard(cardId, data) {
      const card = document.getElementById(cardId);
      card.className = 'status-card ' + data.class;
      card.querySelector('.status-icon').textContent = data.icon;
      card.querySelector('.status-value').textContent = data.status;
    }
    
    // Auto-refresh every 30 seconds (demo only)
    // In production, fetch from real /health endpoint
    setInterval(checkHealth, 30000);
  </script>
</body>
</html>
