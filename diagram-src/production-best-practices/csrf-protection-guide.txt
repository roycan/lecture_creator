ğŸ” CSRF ATTACK PREVENTION
====================================

SCENARIO: Cross-Site Request Forgery Attack
-------------------------------------------

WITHOUT CSRF PROTECTION âŒ
--------------------------

1. User logs into Barangay Admin
   â”œâ”€ Browser stores session cookie
   â””â”€ Cookie sent automatically with ALL requests

2. User visits malicious website (evil.com)
   â””â”€ While STILL logged into Barangay Admin!

3. Malicious website contains hidden form:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ <form action="https://barangay.com/  â”‚
   â”‚        residents/delete/123"         â”‚
   â”‚        method="POST">                â”‚
   â”‚   <input type="hidden" name="id"     â”‚
   â”‚          value="123">                â”‚
   â”‚   <script>                           â”‚
   â”‚     // Auto-submit form!             â”‚
   â”‚     document.forms[0].submit();      â”‚
   â”‚   </script>                          â”‚
   â”‚ </form>                              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. Browser sends request to barangay.com
   â”œâ”€ Includes session cookie (automatic!)
   â”œâ”€ Server thinks it's legitimate request
   â””â”€ Resident #123 DELETED! ğŸ˜±

RESULT: Attacker deleted resident without authorization!


WITH CSRF PROTECTION âœ…
------------------------

1. Server generates unique CSRF token for each session
   â””â”€ Token: "abc123xyz789random"

2. Token embedded in ALL forms:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ <form action="/residents/delete/123" â”‚
   â”‚        method="POST">                â”‚
   â”‚   <!-- CSRF Token (required!) -->    â”‚
   â”‚   <input type="hidden" name="_csrf"  â”‚
   â”‚          value="abc123xyz789random"> â”‚
   â”‚   <button>Delete</button>            â”‚
   â”‚ </form>                              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. Attacker's website tries same attack:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ <form action="https://barangay.com/  â”‚
   â”‚        residents/delete/123"         â”‚
   â”‚        method="POST">                â”‚
   â”‚   <!-- Attacker doesn't have token! -->
   â”‚   <input type="hidden" name="_csrf"  â”‚
   â”‚          value="WRONG_OR_MISSING">   â”‚
   â”‚ </form>                              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. Server checks CSRF token:
   â”œâ”€ Expected: "abc123xyz789random"
   â”œâ”€ Received: "WRONG_OR_MISSING"
   â”œâ”€ Tokens don't match!
   â””â”€ ğŸš« REQUEST BLOCKED! (403 Forbidden)

5. Resident NOT deleted
   â””â”€ Attack prevented! âœ…

RESULT: Only forms from YOUR website can modify data!


HOW TO IMPLEMENT (Express)
---------------------------

STEP 1: Install package
â”œâ”€ npm install csrf-sync

STEP 2: Setup middleware
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ const { csrfSync } = require('csrf-sync');     â”‚
â”‚                                                â”‚
â”‚ const { generateToken,                         â”‚
â”‚         csrfSynchronisedProtection } =         â”‚
â”‚   csrfSync();                                  â”‚
â”‚                                                â”‚
â”‚ // Apply protection to ALL POST routes         â”‚
â”‚ app.use(csrfSynchronisedProtection);           â”‚
â”‚                                                â”‚
â”‚ // Make token available to views               â”‚
â”‚ app.use((req, res, next) => {                  â”‚
â”‚   res.locals.csrfToken = generateToken(req);   â”‚
â”‚   next();                                      â”‚
â”‚ });                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 3: Add token to EVERY form
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ <form method="POST" action="/residents/add">   â”‚
â”‚   <!-- CSRF Token (REQUIRED!) -->              â”‚
â”‚   <input type="hidden" name="_csrf"            â”‚
â”‚          value="<%= csrfToken %>">             â”‚
â”‚                                                â”‚
â”‚   <!-- Your form fields -->                    â”‚
â”‚   <input type="text" name="name">              â”‚
â”‚   <button type="submit">Submit</button>        â”‚
â”‚ </form>                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 4: Middleware automatically validates!
â”œâ”€ On POST/PUT/DELETE requests
â”œâ”€ Checks _csrf field matches session token
â”œâ”€ If valid â†’ Allow request
â””â”€ If invalid â†’ Block with 403 error


WHEN TO USE CSRF PROTECTION
----------------------------

âœ… ALWAYS use for:
â”œâ”€ Forms that modify data (POST, PUT, DELETE)
â”œâ”€ Admin panels
â”œâ”€ User account management
â”œâ”€ Financial transactions
â””â”€ Any destructive action

âŒ NOT needed for:
â”œâ”€ GET requests (read-only)
â”œâ”€ Public APIs (use API keys instead)
â””â”€ Pure static pages


REAL PHILIPPINE EXAMPLES
-------------------------

SCENARIO 1: Barangay Resident Directory
â”œâ”€ Forms need CSRF:
â”‚   â”œâ”€ Add resident
â”‚   â”œâ”€ Update resident info
â”‚   â”œâ”€ Delete resident
â”‚   â””â”€ Issue certificate
â””â”€ Prevents: Unauthorized deletion/modification

SCENARIO 2: Sari-Sari Store Inventory
â”œâ”€ Forms need CSRF:
â”‚   â”œâ”€ Add product
â”‚   â”œâ”€ Update stock
â”‚   â”œâ”€ Record sale
â”‚   â””â”€ Generate report
â””â”€ Prevents: Fake sales, inventory tampering

SCENARIO 3: School Enrollment System
â”œâ”€ Forms need CSRF:
â”‚   â”œâ”€ Enroll student
â”‚   â”œâ”€ Update grades
â”‚   â”œâ”€ Drop course
â”‚   â””â”€ Generate transcript
â””â”€ Prevents: Unauthorized enrollment changes


COMMON MISTAKES
----------------

âŒ MISTAKE 1: Forgetting token in forms
â”œâ”€ Result: All forms break (403 errors)
â””â”€ Fix: Add <input type="hidden" name="_csrf" value="<%= csrfToken %>">

âŒ MISTAKE 2: Applying to GET requests
â”œâ”€ Result: Navigation breaks (can't view pages)
â””â”€ Fix: CSRF only for POST/PUT/DELETE

âŒ MISTAKE 3: Token in URL (query params)
â”œâ”€ Result: Token leaked in logs/history
â””â”€ Fix: Use hidden form field, NOT URL

âŒ MISTAKE 4: Not setting up session
â”œâ”€ Result: CSRF won't work (needs session storage)
â””â”€ Fix: app.use(session({...})) BEFORE CSRF middleware


TESTING CSRF PROTECTION
------------------------

TEST 1: Valid form submission
â”œâ”€ Fill form on your site
â”œâ”€ Submit
â””â”€ âœ… Should work

TEST 2: Form without token
â”œâ”€ Remove <input name="_csrf"> from form
â”œâ”€ Submit
â””â”€ ğŸš« Should get 403 Forbidden

TEST 3: Form with wrong token
â”œâ”€ Change token value to "wrong_token"
â”œâ”€ Submit
â””â”€ ğŸš« Should get 403 Forbidden

TEST 4: External site attack (simulated)
â”œâ”€ Create form on different domain
â”œâ”€ Try to submit to your app
â””â”€ ğŸš« Should fail (no valid token)


SUMMARY
-------

CSRF Protection = Form Security Token

Without it:
â”œâ”€ Attackers can forge requests
â”œâ”€ Data can be modified/deleted
â””â”€ Users are vulnerable

With it:
â”œâ”€ Only YOUR forms work
â”œâ”€ External sites can't forge requests
â””â”€ Data is protected

Implementation:
â”œâ”€ 3 lines of setup
â”œâ”€ 1 line per form
â””â”€ Automatic protection

ALWAYS USE CSRF PROTECTION FOR PRODUCTION APPS! ğŸ›¡ï¸
