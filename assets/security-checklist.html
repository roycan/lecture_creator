<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Security Setup Checklist</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .security-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border-left: 4px solid #dc3545;
    }
    .security-section.secure {
      border-left-color: #28a745;
    }
    .code-example {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      overflow-x: auto;
    }
    .checklist-item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border: 2px solid #ddd;
      cursor: pointer;
      transition: all 0.3s;
    }
    .checklist-item:hover {
      border-color: #3273dc;
    }
    .checklist-item.done {
      border-color: #28a745;
      background: #d4edda;
    }
    .checklist-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      vertical-align: middle;
    }
    .attack-example {
      background: #fff3cd;
      padding: 15px;
      border-left: 4px solid #ffc107;
      margin: 15px 0;
      border-radius: 5px;
    }
    .prevention {
      background: #d4edda;
      padding: 15px;
      border-left: 4px solid #28a745;
      margin: 15px 0;
      border-radius: 5px;
    }
    .package-install {
      background: #e7f3ff;
      padding: 10px 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      margin: 10px 0;
    }
    #progress-bar {
      width: 100%;
      height: 30px;
      background: #f0f0f0;
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
    }
    #progress-fill {
      height: 100%;
      background: linear-gradient(to right, #3273dc, #28a745);
      width: 0%;
      transition: width 0.5s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üõ°Ô∏è Security Setup Checklist for Express Apps</h1>
      <p><strong>Goal:</strong> Protect your app from common attacks</p>
      <p><strong>For:</strong> Sari-sari stores, barangay systems, any production app</p>

      <!-- Progress Bar -->
      <div id="progress-bar">
        <div id="progress-fill">0% Secure</div>
      </div>

      <!-- Security Layer 1: Helmet -->
      <div class="security-section">
        <h2>ü™ñ Layer 1: Helmet.js (Security Headers)</h2>
        <p><strong>Protects against:</strong> XSS, clickjacking, MIME sniffing</p>
        <p><strong>Difficulty:</strong> ‚≠ê Very Easy (2 lines of code!)</p>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Install helmet package</strong>
        </div>
        <div class="package-install">npm install helmet</div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Add helmet to app.js</strong>
        </div>
        <div class="code-example">const helmet = require('helmet');

// Add this EARLY in your middleware
app.use(helmet());</div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Configure for EJS (if using)</strong>
        </div>
        <div class="code-example">app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'", "'unsafe-inline'"]
    }
  }
}));</div>

        <div class="prevention">
          <strong>‚úÖ What this does:</strong>
          <ul>
            <li>Hides what framework you're using (harder to attack)</li>
            <li>Prevents clickjacking (tricking users to click)</li>
            <li>Blocks XSS attacks (malicious scripts)</li>
            <li>Forces HTTPS in production</li>
          </ul>
        </div>
      </div>

      <!-- Security Layer 2: Rate Limiting -->
      <div class="security-section">
        <h2>üö¶ Layer 2: Rate Limiting (Prevent Spam)</h2>
        <p><strong>Protects against:</strong> Brute force attacks, DDoS, spam</p>
        <p><strong>Difficulty:</strong> ‚≠ê‚≠ê Easy</p>

        <div class="attack-example">
          <strong>üö® Attack Example:</strong> Someone makes 1000 login attempts per second trying to guess password.
        </div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Install express-rate-limit</strong>
        </div>
        <div class="package-install">npm install express-rate-limit</div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Create general rate limiter (all routes)</strong>
        </div>
        <div class="code-example">const rateLimit = require('express-rate-limit');

const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 minutes
  max: 100,                   // 100 requests per IP
  message: 'Too many requests. Please try again later.'
});

app.use(generalLimiter);</div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Create strict limiter for login routes</strong>
        </div>
        <div class="code-example">const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 minutes
  max: 5,                     // Only 5 login attempts
  message: 'Too many login attempts. Try again in 15 minutes.'
});

app.use('/login', loginLimiter);
app.use('/admin/login', loginLimiter);</div>

        <div class="prevention">
          <strong>‚úÖ Philippine Example:</strong> Barangay certificate requests limited to 5 per hour (prevents abuse).
        </div>
      </div>

      <!-- Security Layer 3: CSRF Protection -->
      <div class="security-section">
        <h2>üé´ Layer 3: CSRF Protection (Form Security)</h2>
        <p><strong>Protects against:</strong> Cross-Site Request Forgery</p>
        <p><strong>Difficulty:</strong> ‚≠ê‚≠ê‚≠ê Moderate</p>

        <div class="attack-example">
          <strong>üö® Attack Example:</strong> You're logged into barangay admin. You visit a bad website. That website secretly submits a form to DELETE all residents!
        </div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Install csrf-sync package</strong>
        </div>
        <div class="package-install">npm install csrf-sync</div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Setup CSRF middleware</strong>
        </div>
        <div class="code-example">const { csrfSync } = require('csrf-sync');

const { generateToken, csrfSynchronisedProtection } = csrfSync();

// Apply protection
app.use(csrfSynchronisedProtection);

// Make token available to views
app.use((req, res, next) => {
  res.locals.csrfToken = generateToken(req);
  next();
});</div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Add CSRF token to ALL forms</strong>
        </div>
        <div class="code-example">&lt;form method="POST" action="/residents/add"&gt;
  &lt;!-- CSRF Token (REQUIRED!) --&gt;
  &lt;input type="hidden" name="_csrf" value="&lt;%= csrfToken %&gt;"&gt;
  
  &lt;!-- Your form fields --&gt;
  &lt;input type="text" name="name" required&gt;
  &lt;button type="submit"&gt;Submit&lt;/button&gt;
&lt;/form&gt;</div>

        <div class="prevention">
          <strong>‚úÖ Result:</strong> Forms only work from YOUR website. Attackers can't forge requests!
        </div>
      </div>

      <!-- Security Layer 4: Input Validation -->
      <div class="security-section">
        <h2>‚úÖ Layer 4: Input Validation (Never Trust Users)</h2>
        <p><strong>Protects against:</strong> XSS, SQL injection, crashes</p>
        <p><strong>Difficulty:</strong> ‚≠ê‚≠ê‚≠ê Moderate</p>

        <div class="attack-example">
          <strong>üö® Attack Example:</strong> User enters <code>&lt;script&gt;alert('hacked')&lt;/script&gt;</code> in name field. Script executes on your page!
        </div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Install express-validator</strong>
        </div>
        <div class="package-install">npm install express-validator</div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Create validation rules</strong>
        </div>
        <div class="code-example">const { body, validationResult } = require('express-validator');

const validateResident = [
  body('firstName')
    .trim()
    .notEmpty().withMessage('First name required')
    .isLength({ min: 2, max: 50 })
    .matches(/^[a-zA-Z\s\-√±√ë]+$/),
  
  body('age')
    .isInt({ min: 0, max: 120 }),
  
  body('contactNumber')
    .optional()
    .matches(/^(09|\+639)\d{9}$/)
];</div>

        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Apply validation to routes</strong>
        </div>
        <div class="code-example">app.post('/residents/add', validateResident, (req, res) => {
  const errors = validationResult(req);
  
  if (!errors.isEmpty()) {
    return res.render('form', { 
      errors: errors.array(),
      formData: req.body 
    });
  }
  
  // Validation passed - safe to use data!
  const { firstName, age, contactNumber } = req.body;
  // Save to database...
});</div>

        <div class="prevention">
          <strong>‚úÖ What gets validated:</strong>
          <ul>
            <li>Name: Only letters (no scripts!)</li>
            <li>Age: Numbers 0-120 only</li>
            <li>Phone: Philippine format only (09xxxxxxxxx)</li>
            <li>Too long text: Rejected</li>
          </ul>
        </div>
      </div>

      <!-- Complete Setup Example -->
      <div class="security-section secure">
        <h2>üèÜ Complete Secure Setup</h2>
        <p><strong>All 4 layers combined!</strong></p>
        
        <div class="code-example">require('dotenv').config();
const express = require('express');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const { csrfSync } = require('csrf-sync');
const { body, validationResult } = require('express-validator');
const session = require('express-session');

const app = express();

// 1. Helmet (security headers)
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'", "'unsafe-inline'"]
    }
  }
}));

// 2. Body parsing
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// 3. Session (required for CSRF)
app.use(session({
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production',
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000
  }
}));

// 4. CSRF protection
const { generateToken, csrfSynchronisedProtection } = csrfSync();
app.use(csrfSynchronisedProtection);
app.use((req, res, next) => {
  res.locals.csrfToken = generateToken(req);
  next();
});

// 5. Rate limiting
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100
});
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5
});

app.use(generalLimiter);
app.use('/login', loginLimiter);

// Views
app.set('view engine', 'ejs');

// Your secure routes with validation...
// (Add your routes here)

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`üõ°Ô∏è Secure app running on port ${PORT}`);
});</div>
      </div>

      <!-- Final Checklist -->
      <div class="card" style="background: #f0f9ff; margin-top: 30px;">
        <h2>üìã Pre-Deployment Security Checklist</h2>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Environment variables setup</strong> - All secrets in .env
        </div>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>.env in .gitignore</strong> - Never committed to GitHub
        </div>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Helmet installed and configured</strong> - Security headers
        </div>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Rate limiting on login routes</strong> - Prevent brute force
        </div>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>CSRF protection on all forms</strong> - Tokens in place
        </div>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Input validation on all routes</strong> - Sanitize user data
        </div>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Session configured properly</strong> - Secure cookies in production
        </div>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Strong passwords used</strong> - Not "password123"
        </div>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Railway environment variables set</strong> - Production config
        </div>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Tested locally</strong> - Everything works
        </div>
        
        <div class="checklist-item" onclick="toggleCheck(this)">
          <input type="checkbox" onclick="event.stopPropagation(); updateProgress()">
          <strong>Tested on Railway</strong> - Production deploy successful
        </div>
      </div>

      <div id="completion-message" style="display: none; margin-top: 30px; padding: 20px; background: #d4edda; border-radius: 8px; text-align: center;">
        <h2>üéâ Your App is Secure!</h2>
        <p style="font-size: 18px;">All security layers implemented. You can deploy with confidence!</p>
      </div>
    </div>
  </div>

  <script>
    function toggleCheck(element) {
      const checkbox = element.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      
      if (checkbox.checked) {
        element.classList.add('done');
      } else {
        element.classList.remove('done');
      }
      
      updateProgress();
    }

    function updateProgress() {
      const checkboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]');
      const total = checkboxes.length;
      const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percentage = Math.round((checked / total) * 100);
      
      const progressFill = document.getElementById('progress-fill');
      progressFill.style.width = percentage + '%';
      progressFill.textContent = percentage + '% Secure';
      
      // Show completion message if 100%
      const completionMessage = document.getElementById('completion-message');
      if (percentage === 100) {
        completionMessage.style.display = 'block';
      } else {
        completionMessage.style.display = 'none';
      }
    }

    // Initialize progress on page load
    updateProgress();
  </script>
</body>
</html>
