```mermaid
flowchart TD
    A[Database Running] --> B[Backup Strategy]
    
    B --> C[Manual Backup]
    B --> D[Automatic Backup]
    B --> E[Offsite Backup]
    
    C --> F[Admin Clicks Button]
    F --> G[utils/backup.js]
    G --> H[fs.copyFileSync]
    H --> I[backups/backup-TIMESTAMP.db]
    
    D --> J[node-cron Schedule]
    J --> K[2:00 AM Daily]
    K --> G
    I --> L[Clean Old Backups]
    L --> M{Age > 7 Days?}
    M -->|Yes| N[Delete Old File]
    M -->|No| O[Keep File]
    
    E --> P{Railway?}
    P -->|Yes| Q[Download via Admin UI]
    P -->|Yes| R[Email Backup Weekly]
    P -->|Yes| S[Google Drive Upload]
    P -->|No| T[Keep Local Backups]
    
    Q --> U[Store in Google Drive]
    R --> U
    S --> U
    
    style C fill:#e1f5ff
    style D fill:#e1ffe1
    style E fill:#fff4e1
    style U fill:#ffe1e1
```

# Database Backup Strategy

## 3-Layer Backup Approach

### Layer 1: Manual Backups (On-Demand)
**When:** Before major changes or updates
**How:** Admin clicks "Create Backup" button

```javascript
// utils/backup.js
function backupDatabase(dbPath) {
  const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
  const backupFilename = `backup-${timestamp}.db`;
  const backupPath = path.join('backups', backupFilename);
  
  fs.copyFileSync(dbPath, backupPath);
  console.log('âœ… Backup created:', backupFilename);
  
  return { success: true, filename: backupFilename };
}
```

**Pros:**
- âœ… Full control over when to backup
- âœ… Quick and easy
- âœ… Can be done before risky operations

**Cons:**
- âŒ Requires manual action
- âŒ Easy to forget

---

### Layer 2: Automatic Daily Backups
**When:** Every day at 2:00 AM
**How:** node-cron scheduled task

```javascript
// app.js
const cron = require('node-cron');
const { backupDatabase, cleanOldBackups } = require('./utils/backup');

// Run every day at 2:00 AM
cron.schedule('0 2 * * *', () => {
  console.log('ğŸ• Running automatic backup...');
  
  const dbPath = path.join(__dirname, 'database.db');
  backupDatabase(dbPath);
  
  // Keep only last 7 days
  const backupsDir = path.join(__dirname, 'backups');
  cleanOldBackups(backupsDir, 7);
});
```

**Cron Schedule Patterns:**
```
0 2 * * *      â†’ Every day at 2:00 AM
0 */6 * * *    â†’ Every 6 hours
0 0 * * 0      â†’ Every Sunday at midnight
*/30 * * * *   â†’ Every 30 minutes
```

**Pros:**
- âœ… No manual action required
- âœ… Consistent daily backups
- âœ… Old backups automatically cleaned

**Cons:**
- âŒ Backups lost if server crashes
- âŒ Railway ephemeral storage issue

---

### Layer 3: Offsite Backups (Critical!)
**When:** Weekly or monthly
**How:** Download or email backups

#### Option A: Download via Admin UI
```javascript
app.get('/admin/download-backup', requireAdmin, (req, res) => {
  const dbPath = path.join(__dirname, 'database.db');
  const filename = `barangay-backup-${new Date().toISOString().split('T')[0]}.db`;
  
  res.download(dbPath, filename);
});
```

#### Option B: Email Backup
```javascript
// Weekly email backup (Sundays at 3:00 AM)
cron.schedule('0 3 * * 0', async () => {
  await emailBackup('database.db');
});
```

#### Option C: Google Drive Upload
```javascript
// Monthly upload to Google Drive
cron.schedule('0 4 1 * *', async () => {
  await uploadToDrive('database.db');
});
```

**Pros:**
- âœ… Safe from server crashes
- âœ… Works with Railway ephemeral storage
- âœ… Can restore from anywhere

**Cons:**
- âŒ Requires external service setup
- âŒ Email attachments have size limits

---

## Backup File Structure

```
my-app/
â”œâ”€â”€ database.db                           â† Production database
â”œâ”€â”€ backups/                              â† Local backups (7 days)
â”‚   â”œâ”€â”€ backup-2024-01-16T02-00-00.db   â† Today
â”‚   â”œâ”€â”€ backup-2024-01-15T02-00-00.db   â† Yesterday
â”‚   â”œâ”€â”€ backup-2024-01-14T02-00-00.db
â”‚   â”œâ”€â”€ backup-2024-01-13T02-00-00.db
â”‚   â”œâ”€â”€ backup-2024-01-12T02-00-00.db
â”‚   â”œâ”€â”€ backup-2024-01-11T02-00-00.db
â”‚   â””â”€â”€ backup-2024-01-10T02-00-00.db   â† 7 days ago (oldest)
â””â”€â”€ offsite-backups/                      â† Downloaded/emailed backups
    â”œâ”€â”€ monthly-2024-01.db               â† Monthly archive
    â”œâ”€â”€ monthly-2023-12.db
    â””â”€â”€ pre-migration-2024-01-05.db      â† Before major changes
```

---

## Restore Procedure

### Step 1: Stop the Server
```bash
# Railway: No need, will auto-restart
# Local: Ctrl+C to stop
```

### Step 2: Backup Current Database (Just in Case)
```bash
cp database.db database.db.broken
```

### Step 3: Restore from Backup
```bash
cp backups/backup-2024-01-15T02-00-00.db database.db
```

### Step 4: Restart Server
```bash
npm start
```

---

## Railway-Specific Strategy

âš ï¸ **Railway Problem:** Ephemeral storage means backups in `/backups` folder are lost on restart!

**Solution: 3-Part Strategy**

1. **Daily automatic backups** (short-term recovery)
   - Helps recover from bugs/mistakes within same day
   - Lost on server restart but better than nothing

2. **Weekly manual download** (medium-term)
   - Admin downloads backup every Monday
   - Stores in Google Drive/Dropbox
   - Can restore data from last week

3. **Monthly offsite backup** (long-term)
   - Automated email or Google Drive upload
   - Archive of important milestones
   - Disaster recovery backup

---

## Cleanup Strategy

**Keep 7 days of local backups:**
```javascript
function cleanOldBackups(backupsDir, daysToKeep = 7) {
  const files = fs.readdirSync(backupsDir);
  const now = Date.now();
  const maxAge = daysToKeep * 24 * 60 * 60 * 1000;
  
  files.forEach(file => {
    const filePath = path.join(backupsDir, file);
    const stats = fs.statSync(filePath);
    const age = now - stats.mtimeMs;
    
    if (age > maxAge) {
      fs.unlinkSync(filePath);
      console.log('ğŸ—‘ï¸ Deleted old backup:', file);
    }
  });
}
```

**Why 7 days?**
- Recent enough to recover from mistakes
- Old enough to not fill up disk space
- Balances storage vs. safety

---

## Testing Your Backup Strategy

### Monthly Backup Test Checklist:
1. âœ… Create manual backup
2. âœ… Verify file exists in `/backups`
3. âœ… Download backup via admin UI
4. âœ… Stop server
5. âœ… Delete database.db
6. âœ… Restore from backup
7. âœ… Restart server
8. âœ… Verify data is intact
9. âœ… Check automatic backup still runs
10. âœ… Document any issues

**Set calendar reminder:** First Monday of every month!
